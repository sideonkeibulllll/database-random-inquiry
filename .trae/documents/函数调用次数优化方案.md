# 函数调用次数优化方案

## 1. 优化目标
- 充分利用 Vercel 边缘缓存减少 API 调用
- 生成静态页面，预加载随机数据
- 减少数据库连接和查询次数

## 2. 具体实施方案

### 2.1 添加 Cache-Control 头部

**修改文件：** `src/api/database.js`
- 在 `handleDatabaseRequest` 函数中添加 Cache-Control 头部
- 设置合理的缓存时间，例如 `public, max-age=3600, s-maxage=86400`
- 使 Vercel CDN 能够缓存 API 响应

### 2.2 实现静态页面生成

**新增文件：** `src/build-static.js`
- 实现构建脚本，用于生成静态页面
- 读取环境变量中的所有数据库配置
- 为每个数据库生成二级页面
- 为每个数据库生成 100 个三级页面，每个页面包含随机数据
- 页面使用鲜明标志（如 `<!-- DATA_START -->` 和 `<!-- DATA_END -->`）包裹数据块

**修改文件：** `package.json`
- 添加 `build` 脚本，运行静态页面生成脚本
- 配置构建命令为 `pnpm build`

### 2.3 优化数据库连接管理

**修改文件：** `src/utils/db.js`
- 增强连接池管理，确保连接复用
- 添加查询结果缓存机制，减少重复查询
- 优化随机数据获取逻辑，提高性能

## 3. 预期效果

- API 响应被 Vercel CDN 缓存，减少函数调用次数
- 静态页面预加载数据，无需实时数据库查询
- 减少数据库连接和查询次数，降低服务器负载
- 提高响应速度，改善用户体验

## 4. 实施步骤

1. 修改 API 路由，添加 Cache-Control 头部
2. 创建静态页面生成脚本
3. 配置构建流程
4. 优化数据库连接管理
5. 测试构建和部署流程

## 5. 技术细节

- **缓存策略：** 使用 `public, max-age=3600, s-maxage=86400`，客户端缓存 1 小时，CDN 缓存 24 小时
- **静态页面格式：** 使用 HTML 格式，数据块用特殊注释标记
- **数据生成：** 使用现有 `getRandomData` 函数生成随机数据
- **构建工具：** 使用 Node.js 脚本，利用现有数据库连接逻辑

该方案将显著减少函数调用次数，充分利用 Vercel 边缘缓存，并通过静态页面预加载数据，提高系统性能和响应速度。